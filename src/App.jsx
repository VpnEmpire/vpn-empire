// src/App.jsx
import React, { useState, useEffect, useRef } from 'react';
import './App.css';
import BottomNav from './components/BottomNav.jsx';
import TopTab from './components/Top.jsx';
import TasksTab from './components/Tasks.jsx';
import Roulette from './components/Roulette.jsx';
import Hometab from './components/Home.jsx';

function App() {
  const [activeTab, setActiveTab] = useState('home');
  const [coins, setCoins] = useState(() => Number(localStorage.getItem('coins')) || 0);
  const [rank, setRank] = useState('');
  const [clicksToday, setClicksToday] = useState(() => Number(localStorage.getItem('clicksToday')) || 0);
  const [hasSubscription, setHasSubscription] = useState(() => localStorage.getItem('hasSubscription') === 'true');
  const [flashes, setFlashes] = useState([]);
  const [userId, setUserId] = useState(null);
  const [isWithdrawApproved, setIsWithdrawApproved] = useState(() =>
    localStorage.getItem('isWithdrawApproved') === 'true'
  );

  const maxClicksPerDay = 100;
  const spinSoundRef = useRef(null);
  const winSoundRef = useRef(null);
  const [canSpin, setCanSpin] = useState(true);
  const [isSpinning, setIsSpinning] = useState(false);
  const [spinResult, setSpinResult] = useState(null);

  const handleApproveWithdraw = () => {
    setIsWithdrawApproved(true);
    localStorage.setItem('isWithdrawApproved', 'true');
  };

  useEffect(() => {
    localStorage.setItem('coins', coins);
    localStorage.setItem('clicksToday', clicksToday);
    localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
  }, [coins, clicksToday, completedTasks]);

  useEffect(() => {
    updateRank(coins);
  }, [coins]);

  useEffect(() => {
    const today = new Date().toDateString();
    if (localStorage.getItem('lastClickDate') !== today) {
      setClicksToday(0);
      localStorage.setItem('lastClickDate', today);
    }
    if (localStorage.getItem('dailyTaskDate') !== today) {
      setCompletedTasks({});
      localStorage.setItem('dailyTaskDate', today);
    }
    if (localStorage.getItem('lastSpinDate') === today) {
      setCanSpin(false);
    }
  }, []);

 useEffect(() => {
  const initTelegram = () => {
    try {
      const tg = window.Telegram?.WebApp;
      if (!tg || !tg.initDataUnsafe) {
        console.warn('Telegram WebApp API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω.');
        return;
      }

      tg.ready(); // Telegram WebApp –≥–æ—Ç–æ–≤

      const user = tg.initDataUnsafe.user;
      const ref = tg.initDataUnsafe.start_param;

      if (user?.id) {
        setUserId(user.id);
        localStorage.setItem('user_id', user.id);
        console.log('user_id:', user.id);

        if (ref) {
          localStorage.setItem('referrer_id', ref);
          console.log('referrer_id:', ref);
        }
      } else {
        console.warn('user.id –Ω–µ –ø–æ–ª—É—á–µ–Ω');
      }

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram:', error);
    }
  };

  // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initTelegram();
  } else {
    window.addEventListener('DOMContentLoaded', initTelegram);
  }

  return () => window.removeEventListener('DOMContentLoaded', initTelegram);
}, []);

  const updateRank = (totalCoins) => {
    if (totalCoins >= 5000) setRank('–õ–µ–≥–µ–Ω–¥–∞ VPN');
    else if (totalCoins >= 2000) setRank('–≠–∫—Å–ø–µ—Ä—Ç');
    else if (totalCoins >= 1000) setRank('–ü—Ä–æ—Ñ–∏');
    else if (totalCoins >= 500) setRank('–ê–≥–µ–Ω—Ç');
    else setRank('–ù–æ–≤–∏—á–æ–∫');
  };
  
const playClickSound = () => {
  const audio = new Audio('/click.mp3');
  audio.play().catch((e) => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e));
};

  const handleClick = (e) => {
¬† if (clicksToday < maxClicksPerDay) {
¬† ¬† const multiplier = Number(localStorage.getItem('clickMultiplier')) || 1;
¬† ¬† setCoins(prev => prev + 1 * multiplier);
¬† ¬† setClicksToday(prev => prev + 1);
¬† ¬† triggerAnimation();
¬† ¬† playClickSound();

¬† ¬† const flash = { x: e.clientX, y: e.clientY, id: Date.now() };
¬† ¬† setFlashes(prev => [...prev, flash]);
¬† ¬† setTimeout(() => {
¬† ¬† ¬† setFlashes(prev => prev.filter(f => f.id !== flash.id));
¬† ¬† }, 400);
¬† }
};

  const triggerAnimation = () => {
    const flash = document.createElement('div');
    flash.className = 'flash';
    document.body.appendChild(flash);
    setTimeout(() => document.body.removeChild(flash), 300);
  };

  const handleComplete = async (key, reward, options = {}) => {
    if (completedTasks[key]) return;

    if (!userId) {
      alert("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id –∏–∑ Telegram.");
      return;
    }

    if (options.requiresReferralCount !== undefined) {
      const res = await fetch(`/api/check-referrals?user_id=${userId}`);
      const data = await res.json();
      if (!data || data.referrals < options.requiresReferralCount) {
        alert(`–ü—Ä–∏–≥–ª–∞—Å–∏ –∫–∞–∫ –º–∏–Ω–∏–º—É–º ${options.requiresReferralCount} –¥—Ä—É–∑–µ–π –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è`);
        return;
      }
    }

    if (options.requiresSubscription) {
      const res = await fetch(`/api/check-subscription?user_id=${userId}`);
      const data = await res.json();
      if (!data.subscribed) {
        alert("–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ");
        return;
      }
    }

    if (options.requiresPayment) {
      const res = await fetch(`/api/check-payment?user_id=${userId}`);
      const data = await res.json();
      if (!data.success) {
        alert("–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π VPN —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞");
        return;
      }
      localStorage.setItem('clickBoost', 'true');
    }

    const updated = { ...completedTasks, [key]: true };
    setCoins(prev => prev + reward);
    setCompletedTasks(updated);
  };
  
 const renderTasks = () => {
  const [tasks, setTasks] = useState(() => {
    const saved = localStorage.getItem('tasks');
    return saved ? JSON.parse(saved) : [
      { key: 'ref1', title: 'üë§ –ü—Ä–∏–≥–ª–∞—Å–∏ 1 –¥—Ä—É–≥–∞', reward: 50, requires: 1, type: 'referral' },
      { key: 'ref2', title: 'üë• –ü—Ä–∏–≥–ª–∞—Å–∏ 2 –¥—Ä—É–∑–µ–π', reward: 100, requires: 2, type: 'referral' },
      { key: 'ref3', title: 'üë• –ü—Ä–∏–≥–ª–∞—Å–∏ 3 –¥—Ä—É–∑–µ–π', reward: 200, requires: 3, type: 'referral' },
      { key: 'ref4', title: 'üë• –ü—Ä–∏–≥–ª–∞—Å–∏ 4 –¥—Ä—É–∑–µ–π', reward: 300, requires: 4, type: 'referral' },
      { key: 'ref5', title: 'üë• –ü—Ä–∏–≥–ª–∞—Å–∏ 5 –¥—Ä—É–∑–µ–π', reward: 400, requires: 5, type: 'referral' },
      { key: 'ref6', title: 'üë• –ü—Ä–∏–≥–ª–∞—Å–∏ 6 –¥—Ä—É–∑–µ–π', reward: 500, requires: 6, type: 'referral' },
      { key: 'ref7', title: 'üë• –ü—Ä–∏–≥–ª–∞—Å–∏ 7 –¥—Ä—É–∑–µ–π', reward: 600, requires: 7, type: 'referral' },
      { key: 'subtg', title: 'üì® –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ Telegram', reward: 100, type: 'subscription', link: 'https://t.me/OrdoHereticusVPN' },
      { key: 'subinsta', title: 'üì∏ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ Instagram', reward: 100, type: 'link', link: 'https://www.instagram.com/internet.bot.001?igsh=MXRhdzRhdmc1aGhybg==' },
      { key: 'socialshare', title: 'üì¢ –†–∞—Å—Å–∫–∞–∂–∏ –æ –Ω–∞—Å –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö', reward: 100, type: 'info' },
      { key: 'comment', title: 'üí¨ –ö–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç', reward: 100, type: 'info' },
      { key: 'reaction', title: '‚ù§Ô∏è –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é', reward: 100, type: 'info' },
      { key: 'dailyvpn', title: 'üõ° –ó–∞–π—Ç–∏ –≤ VPN —Å–µ–≥–æ–¥–Ω—è', reward: 100, type: 'daily' },
      { key: 'activatevpn', title: 'üöÄ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å VPN', reward: 1000, type: 'payment', link: 'https://t.me/OrdoHereticusVPN' },
    ].map(task => ({ ...task, done: false }));
  });

  const [referrals, setReferrals] = useState(0);
  const [userId, setUserId] = useState(localStorage.getItem('user_id') || null);
  const [subscribed, setSubscribed] = useState(false);
  const [vpnActivated, setVpnActivated] = useState(false);

  useEffect(() => {
    const tgId = window?.Telegram?.WebApp?.initDataUnsafe?.user?.id;
    if (tgId) {
      setUserId(tgId);
      fetch(`/api/check-referrals?user_id=${tgId}`).then(res => res.json()).then(data => setReferrals(data.referrals || 0));
      fetch(`/api/check-subscription?user_id=${tgId}`).then(res => res.json()).then(data => setSubscribed(data.subscribed));
      fetch(`/api/check-payment?user_id=${tgId}`).then(res => res.json()).then(data => setVpnActivated(data.success));
    }
  }, []);

  const completeTask = (task) => {
    if (task.done) return;
    if (task.type === 'referral' && referrals < task.requires) {
      alert(`–ü—Ä–∏–≥–ª–∞—Å–∏ ${task.requires} –¥—Ä—É–∑–µ–π`);
      return;
    }
    if (task.type === 'subscription' && !subscribed) {
      alert('–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª');
      return;
    }
    if (task.type === 'payment' && !vpnActivated) {
      alert('–ê–∫—Ç–∏–≤–∏—Ä—É–π VPN —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞');
      return;
    }

    const updated = tasks.map(t => t.key === task.key ? { ...t, done: true } : t);
    setTasks(updated);
    localStorage.setItem('tasks', JSON.stringify(updated));
    setCoins(prev => prev + task.reward);
  };

  const handleClick = (task) => {
    if (task.type === 'referral') {
      const link = `https://t.me/OrdoHereticus_bot/vpnempire?startapp=${userId}`;
      navigator.clipboard.writeText(link);
      alert(`–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞:\n${link}`);
    } else if (task.link) {
      window.open(task.link, '_blank');
    }
  };
   
  return (
    <div className="tasks-tab">
      <h2>üìã –ó–∞–¥–∞–Ω–∏—è</h2>
      {tasks.map(task => (
        <div
          key={task.key}
          className={`task-card ${task.done ? 'completed' : ''}`}
          onClick={() => handleClick(task)}
        >
          <span>
            {task.title}
            {task.type === 'referral' && (
              <span style={{ fontSize: '14px', color: '#888' }}>
                {Math.min(referrals, task.requires)}/{task.requires}
              </span>
            )}
          </span>
          {task.done ? (
            <span className="done">‚úÖ</span>
          ) : (
            <button onClick={(e) => { e.stopPropagation(); completeTask(task); }}>
              üéÅ –ü–æ–ª—É—á–∏—Ç—å {task.reward} –º–æ–Ω–µ—Ç
            </button>
          )}
        </div>
      ))}

      <div className="task-card disabled-task">
        <span>üîí <strong>–°–∫–æ—Ä–æ –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</strong> ‚Äî üîú –û–∂–∏–¥–∞–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π</span>
      </div>
    </div>
  );
};
  const renderHome = () => (
    <div className="main-content">
      <div className="heander-box">
        <div className="coins">üí∞ –ú–æ–Ω–µ—Ç: {coins} $RICH</div>
        <div className="rank">üéñ –ó–≤–∞–Ω–∏–µ: {rank}</div>
      </div>
      <div className="robot-container">
        <img src="/robot.png" alt="robot" className="robot" onClick={handleClick} />
        <div className="clicks-left">üí• {clicksToday}/{maxClicksPerDay} –º–æ–Ω–µ—Ç</div>
      </div>
      <div className="helper-box">
        ü§ñ <strong>–Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫!</strong><br />
        –ö–ª–∏–∫–∞–π –Ω–∞ —Ä–æ–±–æ—Ç–∞ –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –º–æ–Ω–µ—Ç—ã.
      </div>
      {flashes.map(f => (
        <div key={f.id} className="flash" style={{ left: f.x, top: f.y }} />
      ))}
    </div>
  );

    const renderRoulette = () => {
 return <Roulette setCoins={setCoins} />;
};
  
  const renderTop = () => (
    <TopTab coins={coins} />
  );

  const renderWithdraw = () => (
    <div className="withdraw-tab">
      <h2>üí∏ –í—ã–≤–æ–¥</h2>
      <p>–ú–∏–Ω–∏–º—É–º –¥–ª—è –≤—ã–≤–æ–¥–∞: 10000 –º–æ–Ω–µ—Ç</p>
      <button
        disabled={!isWithdrawApproved}
        className={isWithdrawApproved ? 'withdraw-button' : 'withdraw-button disabled'}
        onClick={() => {
          if (isWithdrawApproved) {
            window.open('https://www.instagram.com/internet.bot.001?igsh=MXRhdzRhdmc1aGhybg==', '_blank');
          }
        }}
      >
        {isWithdrawApproved ? '–í—ã–≤–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ Instagram' : '–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è'}
      </button>
      <button
        className="approve-button"
        onClick={handleApproveWithdraw}
        style={{ marginTop: '20px', backgroundColor: 'green', color: 'white' }}
      >
        ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –≤—ã–≤–æ–¥ (–≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ —Ç—ã)
      </button>
    </div>
  );

  const spinWheel = () => {
  if (!canSpin) return;

  setIsSpinning(true);

  const options = [50, 100, 200, 300, 400, 500, 600, 700];
  const result = options[Math.floor(Math.random() * options.length)];

  if (wheelRef.current) {
    wheelRef.current.style.transition = 'transform 4s ease-out';
    const angle = 360 * 5 + Math.floor(Math.random() * 360);
    wheelRef.current.style.transform = `rotate(${angle}deg)`;
  }

  setTimeout(() => {
    setIsSpinning(false);
    setSpinResult(result);
    setCoins((prev) => prev + result);
    setCanSpin(false);
    localStorage.setItem('lastSpinDate', new Date().toDateString());
    if (winSoundRef.current) winSoundRef.current.play();
  }, 4000);
};

  const renderTab = () => {
    switch (activeTab) {
      case 'home': return renderHome();
      case 'tasks': return renderTasks();
      case 'roulette': return renderRoulette();
      case 'top': return renderTop();
      case 'withdraw': return renderWithdraw();
      default: return renderHome();
    }
  };
  
  return (
    <div className="App">
      {renderTab()}
      <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} />
    </div>
  );
}

export default App;
